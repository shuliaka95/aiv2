#!/bin/bash
# Завершить выполнение скрипта, если любая команда завершится ошибкой (для надежности)
set -e

MODEL_FILE="saved_model.pth"

echo "--- $(date): Запуск контейнера ---"

# --- ШАГ 1: ОБУЧЕНИЕ (если модель не найдена) ---
if [ ! -f "$MODEL_FILE" ]; then
    echo "Артефакт модели не найден ($MODEL_FILE). Начинаем процесс обучения на 45 классах..."
    
    # КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Используем python3.10
    # train.py теперь использует настройки из config/settings.py
    python3.10 train.py
    
    echo "--- Обучение завершено. Модель сохранена."
else
    echo "Обученная модель найдена. Пропускаем обучение."
fi

# --- ШАГ 2: ЗАПУСК ВЕБ-СЕРВЕРА (Инференс) ---
echo "--- $(date): Запуск приложения "

# Запуск app.py
exec gunicorn --bind 0.0.0.0:5000 --workers 4 --timeout 120 app:app